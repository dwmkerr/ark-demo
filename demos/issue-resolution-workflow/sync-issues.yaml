apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: sync-issues
  annotations:
    workflows.argoproj.io/title: "Sync Issues"
    workflows.argoproj.io/description: |
      Copies issues from a source repo to a target (working) repo.

      Synced issues link back to the original and are labeled for tracking.
      Idempotent - skips issues already synced.
spec:
  entrypoint: main
  serviceAccountName: argo-workflow

  arguments:
    parameters:
    - name: source-repo
      value: "mckinsey/agents-at-scale-ark"
      description: "Source repository to copy issues from"

    - name: target-repo
      value: "dwmkerr/agents-at-scale-ark"
      description: "Target repository to copy issues to"

    - name: issue-ids
      value: ""
      description: "Comma-separated issue IDs to sync (empty = all open issues)"

    - name: label-filter
      value: ""
      description: "Only sync issues with this label"

    - name: sync-label
      value: "ark:synced"
      description: "Label to add to synced issues in target repo"

    - name: gh-token
      value: ""
      description: "GitHub token with repo access"

  templates:
  - name: main
    dag:
      tasks:
      - name: prepare
        template: prepare

      - name: request-approval
        template: request-approval
        depends: "prepare"
        arguments:
          artifacts:
          - name: sync-plan
            from: "{{tasks.prepare.outputs.artifacts.sync-plan}}"

      - name: sync
        template: sync
        depends: "request-approval"

      - name: finalize
        template: finalize
        depends: "sync"
        arguments:
          artifacts:
          - name: sync-result
            from: "{{tasks.sync.outputs.artifacts.sync-result}}"

  - name: prepare
    metadata:
      annotations:
        workflows.argoproj.io/description: "Fetch issues and prepare sync plan"
    script:
      image: badouralix/curl-jq:latest
      command: [sh]
      env:
      - name: GH_TOKEN
        value: "{{workflow.parameters.gh-token}}"
      source: |
        set -e -o pipefail

        source_repo="{{workflow.parameters.source-repo}}"
        target_repo="{{workflow.parameters.target-repo}}"
        issue_ids="{{workflow.parameters.issue-ids}}"
        label_filter="{{workflow.parameters.label-filter}}"

        echo "Preparing sync from ${source_repo} to ${target_repo}"
        echo ""

        # Fetch issues from source
        if [ -n "$issue_ids" ]; then
          echo "[]" > /tmp/issues.json
          for id in $(echo "$issue_ids" | tr ',' ' '); do
            issue=$(curl -sS \
              -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/${source_repo}/issues/${id}")
            jq --argjson issue "$issue" '. + [$issue]' /tmp/issues.json > /tmp/issues-new.json
            mv /tmp/issues-new.json /tmp/issues.json
          done
          issues_json=$(cat /tmp/issues.json)
        else
          api_url="https://api.github.com/repos/${source_repo}/issues?state=open&per_page=100"
          [ -n "$label_filter" ] && api_url="${api_url}&labels=${label_filter}"
          issues_json=$(curl -sS -H "Authorization: token ${GH_TOKEN}" "$api_url" \
            | jq '[.[] | select(.pull_request == null)]')
        fi

        # Build sync plan
        sync_plan="[]"
        echo "$issues_json" | jq -c '.[]' | while read -r issue; do
          number=$(echo "$issue" | jq -r '.number')
          title=$(echo "$issue" | jq -r '.title')
          url=$(echo "$issue" | jq -r '.html_url')

          # Check if already synced
          search_query="repo:${target_repo} is:issue in:body ${url}"
          existing=$(curl -sS \
            -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/search/issues?q=$(echo "$search_query" | jq -sRr @uri)" \
            | jq '.total_count')

          if [ "$existing" -gt 0 ]; then
            status="skip"
          else
            status="pending"
          fi

          echo "{\"source_number\":${number},\"source_url\":\"${url}\",\"title\":\"${title}\",\"status\":\"${status}\"}"
        done | jq -s '.' > /tmp/sync-plan.json

        # Display plan
        echo "## Sync Plan"
        echo ""
        echo "| Source | Title | Status |"
        echo "|--------|-------|--------|"
        jq -r '.[] | "| [#\(.source_number)](\(.source_url)) | \(.title | .[0:50]) | \(.status) |"' /tmp/sync-plan.json

        pending=$(jq '[.[] | select(.status == "pending")] | length' /tmp/sync-plan.json)
        skip=$(jq '[.[] | select(.status == "skip")] | length' /tmp/sync-plan.json)
        echo ""
        echo "**Pending:** ${pending} | **Skip:** ${skip}"
    outputs:
      artifacts:
      - name: sync-plan
        path: /tmp/sync-plan.json
        archive:
          none: {}

  - name: request-approval
    metadata:
      annotations:
        workflows.argoproj.io/description: |
          Review the sync plan before proceeding.

          To approve: argo resume {{workflow.name}}
          To reject: argo terminate {{workflow.name}}
    inputs:
      artifacts:
      - name: sync-plan
    suspend: {}

  - name: sync
    metadata:
      annotations:
        workflows.argoproj.io/description: "Sync issues to target repo"
    script:
      image: badouralix/curl-jq:latest
      command: [sh]
      env:
      - name: GH_TOKEN
        value: "{{workflow.parameters.gh-token}}"
      source: |
        set -e -o pipefail

        source_repo="{{workflow.parameters.source-repo}}"
        target_repo="{{workflow.parameters.target-repo}}"
        sync_label="{{workflow.parameters.sync-label}}"

        echo "Syncing issues to ${target_repo}"
        echo ""

        # Initialize result
        echo "[]" > /tmp/sync-result.json

        # Get issues to sync
        issue_ids="{{workflow.parameters.issue-ids}}"
        if [ -n "$issue_ids" ]; then
          echo "[]" > /tmp/issues.json
          for id in $(echo "$issue_ids" | tr ',' ' '); do
            issue=$(curl -sS \
              -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/${source_repo}/issues/${id}")
            jq --argjson issue "$issue" '. + [$issue]' /tmp/issues.json > /tmp/issues-new.json
            mv /tmp/issues-new.json /tmp/issues.json
          done
          issues_json=$(cat /tmp/issues.json)
        else
          label_filter="{{workflow.parameters.label-filter}}"
          api_url="https://api.github.com/repos/${source_repo}/issues?state=open&per_page=100"
          [ -n "$label_filter" ] && api_url="${api_url}&labels=${label_filter}"
          issues_json=$(curl -sS -H "Authorization: token ${GH_TOKEN}" "$api_url" \
            | jq '[.[] | select(.pull_request == null)]')
        fi

        echo "$issues_json" | jq -c '.[]' | while read -r issue; do
          number=$(echo "$issue" | jq -r '.number')
          title=$(echo "$issue" | jq -r '.title')
          body=$(echo "$issue" | jq -r '.body // ""')
          url=$(echo "$issue" | jq -r '.html_url')

          # Check if already synced
          search_query="repo:${target_repo} is:issue in:body ${url}"
          existing=$(curl -sS \
            -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/search/issues?q=$(echo "$search_query" | jq -sRr @uri)" \
            | jq '.total_count')

          if [ "$existing" -gt 0 ]; then
            echo "Skipping #${number} (already synced)"
            result="{\"source_number\":${number},\"source_url\":\"${url}\",\"target_number\":null,\"target_url\":null,\"status\":\"skipped\"}"
          else
            # Build new issue body
            new_body="> **Original:** [${source_repo}#${number}](${url})

        ${body}"

            # Create issue
            new_issue=$(jq -n --arg title "$title" --arg body "$new_body" '{title: $title, body: $body}')
            response=$(curl -sS -X POST \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${target_repo}/issues" \
              -d "$new_issue")

            new_number=$(echo "$response" | jq -r '.number')
            new_url=$(echo "$response" | jq -r '.html_url')

            if [ "$new_number" = "null" ]; then
              echo "Failed to sync #${number}"
              result="{\"source_number\":${number},\"source_url\":\"${url}\",\"target_number\":null,\"target_url\":null,\"status\":\"failed\"}"
            else
              # Add label
              curl -sS -X POST \
                -H "Authorization: token ${GH_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${target_repo}/issues/${new_number}/labels" \
                -d "{\"labels\":[\"${sync_label}\"]}" >/dev/null 2>&1 || true

              echo "Synced #${number} -> #${new_number}"
              result="{\"source_number\":${number},\"source_url\":\"${url}\",\"target_number\":${new_number},\"target_url\":\"${new_url}\",\"status\":\"synced\"}"
            fi
          fi

          # Append to result
          jq --argjson r "$result" '. + [$r]' /tmp/sync-result.json > /tmp/sync-result-new.json
          mv /tmp/sync-result-new.json /tmp/sync-result.json
        done

        cat /tmp/sync-result.json
    outputs:
      artifacts:
      - name: sync-result
        path: /tmp/sync-result.json
        archive:
          none: {}

  - name: finalize
    metadata:
      annotations:
        workflows.argoproj.io/description: "Display final sync results"
    inputs:
      artifacts:
      - name: sync-result
        path: /tmp/sync-result.json
    script:
      image: badouralix/curl-jq:latest
      command: [sh]
      source: |
        set -e -o pipefail

        echo "## Sync Results"
        echo ""
        echo "| Source | Target | Status |"
        echo "|--------|--------|--------|"
        jq -r '.[] | "| [#\(.source_number)](\(.source_url)) | \(if .target_number then "[#\(.target_number)](\(.target_url))" else "-" end) | \(.status) |"' /tmp/sync-result.json

        synced=$(jq '[.[] | select(.status == "synced")] | length' /tmp/sync-result.json)
        skipped=$(jq '[.[] | select(.status == "skipped")] | length' /tmp/sync-result.json)
        failed=$(jq '[.[] | select(.status == "failed")] | length' /tmp/sync-result.json)

        echo ""
        echo "**Synced:** ${synced} | **Skipped:** ${skipped} | **Failed:** ${failed}"

        # Copy to output
        cp /tmp/sync-result.json /tmp/final-result.json
    outputs:
      artifacts:
      - name: sync-result
        path: /tmp/final-result.json
        archive:
          none: {}
